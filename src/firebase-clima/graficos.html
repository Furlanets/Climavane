<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr√°ficos Hist√≥ricos (8h) - PUClima</title>
    
    <link rel="icon" type="image/png" href="puclimalogo.png">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="config.js"></script> 
    <script src="menu.js"></script>   

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-top: 4px solid #3498db;
        }

        .chart-title {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header-full">
        <img src="puclimalogo.png" alt="Banner Puclima" style="width: 30%; max-width: 200px; height: auto;">
        <h2 style="color: white; margin-top: 5px; font-weight: normal; font-size: 1.2em;">
            Hist√≥rico (Intervalos de 8h)
        </h2>
    </header>

    <div id="loading" style="text-align: center; margin-top: 50px; font-size: 1.2em; color: #7f8c8d;">
        ‚è≥ Calculando m√©dias por turno...
    </div>

    <div class="dashboard-grid" id="area-graficos" style="display: none;">
        <div class="chart-card">
            <div class="chart-title">üå°Ô∏è Temperatura (¬∞C)</div>
            <canvas id="graficoTemp"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-title">üíß Umidade (%)</div>
            <canvas id="graficoUmid"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-title">‚òî Chuva Acumulada (mm)</div>
            <canvas id="graficoChuva"></canvas>
        </div>
        <div class="chart-card">
            <div class="chart-title">üí® Vento M√©dio (km/h)</div>
            <canvas id="graficoVento"></canvas>
        </div>
    </div>

    <script>
        const db = firebase.database();
        const historicoRef = db.ref('dados_climaticos/temp_externa/historico');

        historicoRef.once('value').then((snapshot) => {
            const dados = snapshot.val();
            
            if (!dados) {
                document.getElementById('loading').innerText = "Nenhum hist√≥rico encontrado.";
                return;
            }

            // --- 1. PROCESSAMENTO DE DADOS (AGRUPAR A CADA 8 HORAS) ---
            const grupos = {}; 

            Object.values(dados).forEach(registro => {
                if (!registro.grava_timestamp) return;

                const dataObj = new Date(registro.grava_timestamp);
                
                // Pega dia e m√™s (ex: 25/11)
                const diaMes = dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                
                // Pega a hora (0 a 23)
                const hora = dataObj.getHours();

                // L√ìGICA DE TURNOS DE 8 HORAS
                // 00-07 = Turno 0 | 08-15 = Turno 1 | 16-23 = Turno 2
                const turno = Math.floor(hora / 8); 
                
                let labelTurno = "";
                if (turno === 0) labelTurno = "00h-08h";
                if (turno === 1) labelTurno = "08h-16h";
                if (turno === 2) labelTurno = "16h-00h";

                // Chave √∫nica: "25/11 08h-16h"
                // Adicionamos um prefixo num√©rico invis√≠vel para ordenar corretamente no gr√°fico depois se precisar,
                // mas aqui usaremos a string direta. O JS costuma ordenar datas ISO, mas chaves string dependem da inser√ß√£o.
                // Vamos simplificar usando a string como chave.
                const chave = `${diaMes} (${labelTurno})`;

                if (!grupos[chave]) {
                    grupos[chave] = { temps: [], umids: [], ventos: [], chuvas: [] };
                }

                if(registro.temperatura_cel) grupos[chave].temps.push(Number(registro.temperatura_cel));
                if(registro.umidade_relativa) grupos[chave].umids.push(Number(registro.umidade_relativa));
                if(registro.velocidade_vento_media_m_s) grupos[chave].ventos.push(Number(registro.velocidade_vento_media_m_s) * 3.6);
                if(registro.chuva_ultima_medicao_mm) grupos[chave].chuvas.push(Number(registro.chuva_ultima_medicao_mm));
            });

            // --- 2. CALCULAR M√âDIAS ---
            // Ordenar as chaves para o gr√°fico n√£o ficar bagun√ßado cronologicamente
            // Como nossa chave come√ßa com dia/m√™s, ela ordena razoavelmente bem para o m√™s atual.
            const labelsOrdenadas = Object.keys(grupos); 

            const mediaTemp = [];
            const mediaUmid = [];
            const mediaVento = [];
            const maxChuva = [];

            labelsOrdenadas.forEach(chave => {
                const g = grupos[chave];
                const calcMedia = (arr) => arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length) : 0;
                const calcMax = (arr) => arr.length ? Math.max(...arr) : 0;

                mediaTemp.push(calcMedia(g.temps));
                mediaUmid.push(calcMedia(g.umids));
                mediaVento.push(calcMedia(g.ventos));
                maxChuva.push(calcMax(g.chuvas));
            });

            // --- 3. CRIAR GR√ÅFICOS ---
            document.getElementById('loading').style.display = 'none';
            document.getElementById('area-graficos').style.display = 'grid';

            const criarGrafico = (idCanvas, label, dados, cor, tipo='line') => {
                new Chart(document.getElementById(idCanvas), {
                    type: tipo,
                    data: {
                        labels: labelsOrdenadas,
                        datasets: [{
                            label: label,
                            data: dados,
                            borderColor: cor,
                            backgroundColor: cor + '33', // Adiciona transpar√™ncia
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { 
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }, // Inclina o texto da data para caber
                            y: { beginAtZero: true } 
                        }
                    }
                });
            };

            criarGrafico('graficoTemp', 'Temp (¬∞C)', mediaTemp, '#e74c3c');
            criarGrafico('graficoUmid', 'Umid (%)', mediaUmid, '#3498db');
            criarGrafico('graficoVento', 'Vento (km/h)', mediaVento, '#95a5a6');
            criarGrafico('graficoChuva', 'Chuva (mm)', maxChuva, '#9b59b6', 'bar');
        });
    </script>
</body>
</html>